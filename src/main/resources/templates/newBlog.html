<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create New Blog Post</title>
    <style>
        body {
          font-family: Arial, sans-serif;
          background: #fff;
          color: #000;
          margin: 0;
          padding: 20px;
        }
        .container {
          max-width: 700px;
          margin: auto;
          padding: 20px;
          border: 1px solid #000;
        }
        h2 { text-align: center; margin-bottom: 20px; }
        label { display: block; margin-top: 10px; }
        input, textarea, select, button {
          width: 100%; padding: 8px; margin-top: 5px; margin-bottom: 10px;
          box-sizing: border-box; border: 1px solid #000; background: #fff; color: #000;
        }
        #selected-tags span {
          display: inline-block; padding: 3px 8px; border: 1px solid #000;
          margin: 2px; cursor: pointer;
        }
        .text-center { text-align: center; }
        #message div {
          padding: 8px; margin-bottom: 10px; border: 1px solid #000;
          background: #fff; color: #000;
        }
        .tag-section { display: flex; gap: 5px; margin-bottom: 5px; }
        .tag-section select { flex: 1; }
        .tag-section button { width: auto; padding: 6px 10px; }
    </style>
</head>
<body>
<div class="container">
    <h2>Create New Blog</h2>
    <div id="message"></div>

    <form id="post-form">
        <label for="title">Title</label>
        <input type="text" id="title" placeholder="Enter post title" required>

        <label for="excerpt">Excerpt</label>
        <input type="text" id="excerpt" placeholder="Enter short excerpt" required>

        <label for="content">Content</label>
        <textarea id="content" rows="6" placeholder="Enter full content" required></textarea>

        <label for="publishedAt">Published At</label>
        <input type="datetime-local" id="publishedAt">

        <label for="author-id">Author ID</label>
        <input type="number" id="author-id" placeholder="Enter Author ID" required>

        <label>Tags</label>
        <div class="tag-section">
            <select id="tag-select">
                <option value="" disabled selected>Suggestion</option>
            </select>
            <button type="button" id="add-tag-btn">Add</button>
        </div>
        <input type="text" id="new-tag-input" placeholder="Type new tag and press Enter">
        <div id="selected-tags"></div>

        <label for="isPublished">Publish</label>
        <select id="isPublished">
            <option value="true">Yes</option>
            <option value="false" selected>No</option>
        </select>

        <div class="text-center">
            <button type="submit">Create Post</button>
        </div>
    </form>
</div>

<script>
    let selectedTags = [];

    // Use current origin for both local and Railway deployment
    const BASE_URL = window.location.origin;

    const token = localStorage.getItem('token');
    if (!token) {
        alert('Session expired or not logged in. Please log in again.');
        window.location.href = '/login';
    }

    async function secureFetch(url, options = {}) {
        const headers = options.headers || {};
        headers['Authorization'] = `Bearer ${token}`;
        headers['Content-Type'] = 'application/json';
        options.headers = headers;

        const response = await fetch(url, options);
        if (response.status === 401 || response.status === 403) {
            alert('Session expired. Please log in again.');
            localStorage.removeItem('token');
            window.location.href = '/login';
        }
        return response;
    }

    // Fetch tags
    secureFetch(`${BASE_URL}/tag`, { method: 'GET' })
      .then(res => res.json())
      .then(result => {
          const tags = result.data || [];
          const tagSelect = document.getElementById('tag-select');
          tags.forEach(tag => {
              const option = document.createElement('option');
              option.value = tag.name;
              option.textContent = tag.name;
              tagSelect.appendChild(option);
          });
      })
      .catch(err => console.error("Error fetching tags:", err));

    // Add tag from select
    document.getElementById('add-tag-btn').addEventListener('click', () => {
        const select = document.getElementById('tag-select');
        const tagName = select.value;
        if (tagName && !selectedTags.includes(tagName)) {
            selectedTags.push(tagName);
            addTagToUI(tagName);
        }
    });

    // Add tag from input
    document.getElementById('new-tag-input').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            const tagName = e.target.value.trim();
            if (tagName && !selectedTags.includes(tagName)) {
                selectedTags.push(tagName);
                addTagToUI(tagName);
                e.target.value = '';
            }
        }
    });

    function addTagToUI(name) {
        const tagContainer = document.getElementById('selected-tags');
        const badge = document.createElement('span');
        badge.textContent = name;
        badge.title = 'Click to remove';
        badge.onclick = () => {
            selectedTags = selectedTags.filter(t => t !== name);
            tagContainer.removeChild(badge);
        };
        tagContainer.appendChild(badge);
    }

    // Submit post
    document.getElementById('post-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const msg = document.getElementById('message');

        const authorId = document.getElementById('author-id').value;
        if (!authorId) {
            alert('Please enter Author ID.');
            return;
        }

        const data = {
            title: document.getElementById('title').value,
            excerpt: document.getElementById('excerpt').value,
            content: document.getElementById('content').value,
            publishedAt: document.getElementById('publishedAt').value || null,
            isPublished: document.getElementById('isPublished').value === 'true',
            author: { id: parseInt(authorId) },
            tags: selectedTags.map(name => ({ name }))
        };

        try {
            const response = await secureFetch(`${BASE_URL}/post`, {
                method: 'POST',
                body: JSON.stringify(data)
            });

            const result = await response.json();
            if (result.data) {
                msg.innerHTML = `<div>âœ… Post created successfully! Redirecting...</div>`;
                document.getElementById('post-form').reset();
                selectedTags = [];
                document.getElementById('selected-tags').innerHTML = '';
                setTimeout(() => window.location.href = `${BASE_URL}/`, 2000);
            } else {
                msg.innerHTML = `<div>Failed to create post.</div>`;
            }
        } catch (error) {
            console.error("Error creating post:", error);
            msg.innerHTML = `<div>Error submitting post. Check console for details.</div>`;
        }
    });
</script>
</body>
</html>
